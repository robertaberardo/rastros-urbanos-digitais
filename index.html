<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>rastros urbanos digitais</title>
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>


    <link href="https://fonts.googleapis.com/css?family=Raleway|Lora|Raleway+Dots" rel="stylesheet">


    <script src="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.14.1/mapbox-gl.css" rel="stylesheet" />

    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://cdn.plot.ly/plotly-locale-pt-br-latest.js"></script>
    <script src="https://unpkg.com/deck.gl@^8.9.18/dist.min.js"></script>
    <!-- <script src="https://unpkg.com/@luma.gl/shadertools@8.5.20/dist/dist.min.js"></script> -->




    <script src="https://cdn.jsdelivr.net/npm/d3-color@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-interpolate@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-scale-chromatic@3"></script>

    <!-- ver quais precisam desse, time acho que não né -->
    <script src="https://cdn.jsdelivr.net/npm/d3-array@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-format@3"></script>
    <!-- <script src="https://cdn.jsdelivr.net/npm/d3-time@3"></script>
    <script src="https://cdn.jsdelivr.net/npm/d3-time-format@4"></script> -->
    <script src="https://cdn.jsdelivr.net/npm/d3-scale@4"></script>


    <!-- Importação de scripts -->

    <!-- Core -->
    <script src="scripts/core/coreFunctions.js"></script>

    <!-- Title -->
    <script src="scripts/title_animation/titleData.js"></script>
    <script src="scripts/title_animation/uniquePlaces20220101.js"></script>
    <!-- <script src="scripts/destinationData.js"></script> -->

    <!-- Importar dados de destinos antes do Title Function-->
    <script src="scripts/title_animation/titleFunctions.js"></script>

    <!-- Users Path -->
    <script src="scripts/users_path/usersPathPointData.js"></script>
    <script src="scripts/users_path/usersPathsFunctions.js"></script>


    <!-- All Tweets -->
    <script src="scripts/all_tweets/uniquePlacesByDateData.js"></script>
    <script src="scripts/all_tweets/uniquePlacesCountData.js"></script>
    <script src="scripts/all_tweets/allTweetsFunctions.js"></script>



    <!-- Places Tweets -->
    <script src="scripts/places/uniquePlacesCountByDateData.js"></script>
    <script src="scripts/places/displayPointsInPlace.js"></script>
    <!-- <script src="scripts/places/maspLocationData.js"></script> -->
    <!-- <script src="scripts/places/brahmaLocationData.js"></script> -->
    <script src="scripts/places/paulistaLocationData.js"></script>
    <script src="scripts/places/newoQuimicaArenaLocationData.js"></script>

    <!-- Network -->
    <script src="scripts/networks/networkFunctions.js"></script>
    <!-- <script src="scripts/networks/azulRedeEstacoes1505.js"></script>
    <script src="scripts/networks/animateEstacoesFunctions.js"></script> -->
    <script src="scripts/networks/networksDistanceCount.js"></script>
    <script src="scripts/networks/deckGLNetworkDistanceCount.js"></script>
    <script src="scripts/networks/deckGLNetworkDistanceCountData.js"></script>
    <script src="scripts/networks/allNetworksInteractive.js"></script>

    <style>
        body {
            margin: 0;
            padding: 0;
            color: rgb(113, 57, 28);
            /*  #a8785e */
            font-family: Lora
        }

        .container {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        #map {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            pointer-events: none
        }

        #forward-button {
            position: fixed;
            top: 80%;
            z-index: 10;
            right: 50px;
            margin: 10px auto 0;
            background-repeat: no-repeat;
            background-position: center;
            display: block;
            background-color: transparent;
            border: none;
            cursor: pointer;
            z-index: 1;
            opacity: 0
        }

        .lt {
            position: absolute;
            left: 35px;
            /* padding: 5px; */
            font-size: large;
            z-index: 4;
            width: 400px;
            /* opacity: 0; */
            text-align: center;
            align-self: center;
            transition: opacity 2s;
            -webkit-transition: opacity 2s;
            /* Safari */
            transform: translate(0, -50%);
        }

        #left-text-span{
            background-color: rgb(232 227 223 / 40%);
            opacity: 0;
        }

        #upper-left-text-span{
            background-color: rgb(232 227 223 / 40%);
            opacity: 0;
        }

        #left-text {
            top: 50%;
        }

        #upper-left-text {
            top: 20%;
            /* opacity: 0; */
            transform: translate(0, 0);
        }

        #lower-left-text {
            top: 60%;
            opacity: 0;
        }

        #right-text {
            position: absolute;
            top: 6%;
            right: 4%;
            font-size: medium;
            z-index: 1;
            opacity: 0;
            transition: opacity 2s;
            -webkit-transition: opacity 2s;
            /* Safari */
        }

        #chart-container {
            z-index: 1;
            position: fixed;
            width: 42%;
            bottom: 35px;
            left: 35px
        }

        #chart {
            z-index: 9999;
            position: fixed;
            width: 42%;
            bottom: 35px;
            left: 35px
        }

        #network-chart {
            z-index: 1;
            position: fixed;
            width: 42%;
            height: 42%;
            bottom: 35px;
            left: 35px;
            opacity: 0;
            transition: opacity 2s;
            -webkit-transition: opacity 2s;
        }

        #tooltip {
            z-index: 99;
            position: absolute;
            background-color: rgb(173, 216, 230);
            padding: 10px;
            border-radius: 4px;
            font-size: small;
            display: none;
        }


        #legend {
            position: absolute;
            top: 40%;
            right: 4%;
            /* background: #ffffff25; */
            /* background-color: rgba(225, 212, 204, 0.5); */
            /* background-color: rgba(247, 245, 243, 0.5); */
            background-color: rgb(232 227 223 / 50%);;
            overflow: auto;
            border-radius: 3px;
            padding: 10px;
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            line-height: 18px;
            /* height: 150px; */
            margin-bottom: 40px;
            /* width: 100px; */
            opacity: 0;
            transition: opacity 2s;
            -webkit-transition: opacity 2s;
            z-index: 9999
        }

        .legend-key {
            display: inline-block;
            border-radius: 20%;
            width: 10px;
            height: 10px;
            margin-right: 5px;
        }

        a.mapboxgl-ctrl-logo {
            visibility: hidden;
        }

        .mapboxgl-ctrl-top-right {
            right: 1%;
            top: 40%;
        }

        .mapboxgl-ctrl-scale {
            border: 1px solid #71391c;
            background-color: rgba(225, 212, 204, 0.3);
            border-top: #333;
            color: #71391c
        }

        .mapboxgl-ctrl-icon {
            filter: brightness(1000%);
            opacity: 0.8;
        }


        .mapboxgl-ctrl-group:not(:empty) {
            box-shadow: 0 0 0 2px rgba(0, 0, 0, .0);
            background-color: rgba(225, 212, 204, 0.75);
            margin: 0
        }

        .mapboxgl-ctrl-bottom-left {
            bottom: 0;
            display: flex;
            left: 0;
        }

        #final-text {
            font-family: Raleway Dots;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            font-size: 4rem;
            /* xxx-large;  */
            /* 4rem; */
            transition: opacity 5s ease-in-out;
            text-align: center;
        }

        #final-bottom-text {
            position: fixed;
            bottom: 10%;
            left: 50%;
            transform: translate(-50%, -50%);
            opacity: 0;
            font-size: medium;
            transition: opacity 5s ease-in-out;
            text-align: center;
            color: #8aa4b5
        }

        .reset-button {
            padding: 10px;
            font-family: Lora;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: small;
            margin: 4px 2px;
            transition-duration: 0.4s;
            cursor: pointer;
            /* background-color: #eee6e2; */
            background-color: rgba(225, 212, 204, 0.75);
            color: #71391C;
            border-radius: 4px;
            border: 1px solid #71391C;
        }

        .reset-button:hover {
            background-color: #71391C;
            color: white;
        }
    </style>

</head>

<body>
    <div id="map"></div>
    <div class="container">
        <div class='lt' id="upper-left-text"><span id="upper-left-text-span"></span></div>
        <div class='lt' id="left-text"><span id="left-text-span"></span></div>
        <!-- <div class='lt' id="left-text"><span class="lt-span">hello  <br/> hello</span></div> -->
        <!-- <div class='lt' id="lower-left-text"></div> -->
    </div>
    <div id="right-text"></div>
    <div id='legend'></div>
    <button id="forward-button" disabled>
        <img src="assets/md-arrow-dropdown.svg" alt="Forward" />
    </button>
    <div id="chart"></div>
    <div id="network-chart"></div>
    <div id="tooltip"></div>


    <script>
        Plotly.setPlotConfig({ locale: 'pt-BR' })
        // Variáveis globais
        var networkBrahmaLineDistances; // Vai ser usuado futuramente
        var sortedDistances;

        var colors = [];
        var brownColor = '#71391C';

        var reduceMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
        // var brownClearColor = '#a8785e';
        // brownColor = brownClearColor

        // Criação do Mapa
        mapboxgl.accessToken = 'pk.eyJ1Ijoicm9iZXJ0YWJlcmFyZG8iLCJhIjoiY2xoanM3cnNiMGExNDNtcHNkNHBlN2Q3diJ9.LMjQuu3se82ILlphs0Reyg';
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/robertaberardo/cli6wxl3l002201qq6t875by4', // Use your preferred map style
            // style: 'mapbox://styles/robertaberardo/clhjvf4qj00b901pa0czj2brd',
            // center: [-46.710300505629874, -23.039335933857856], // Texto centralizado, antes do deslocamento que fix para direira em reduce
            // center: [-46.817683055965446, -23.106450027817584],


            // Texto centralizado atualizado, ultima revisão centro, antes do deslocamento que fix para direira em reduce
            center: [-46.713774097692905, -23.04150692889725],


            zoom: 9.8, // Set the initial zoom level,
            // interactive: false
        });


        const forwardButton = document.getElementById('forward-button');        
        const leftTextDiv = document.getElementById('left-text');
        const leftText = document.getElementById('left-text-span');
        // const lowerLeftText = document.getElementById('lower-left-text');
        const upperLeftText = document.getElementById('upper-left-text-span');
        const mapContainer = document.getElementById('map');
        const legend = document.getElementById('legend');
        const rightText = document.getElementById('right-text');

        let currentStep = 0;



        const steps = [
            {
                onInit: () => {
                    initTitle();
                    enableForwardButton();
                }
            },
            {
                onInit: () => {
                    disableForwardButton();

                    setTimeout(() => {
                        leftText.style.opacity = 1;
                        leftText.innerHTML = "Ao twittar um autor pode escolher compartilhar a localização no momento do Tweet," +
                            " podendo ser a localização exata do GPS ou uma localização contextual, como um estabelecimento, um bairro.<br><br>" 
                            // + 
                            // "Cada ponto representa uma localização registrada, podendo representar múltiplos tweets.";
                    }, 2000)

                    setTimeout(() => {
                        const scale = new mapboxgl.ScaleControl({
                            maxWidth: 80,
                            unit: 'metric'
                        });
                        map.addControl(scale);

                        rightText.style.opacity = 1;
                        rightText.innerText = 'Tweets de 01 de Janeiro de 2022'
                    }, 2000)


                    animateTitle();
                    enableForwardButtonOnDataIdle();

                    // map.once('idle', function () {
                    //     setTimeout(() => {
                    //         enableForwardButtonOnDataIdle()
                    //     }, 6000)
                    // });


                }
            },
            {
                onInit: () => {
                    map.setMaxBounds(
                        [{
                            "lng": -48.296755335183036,
                            "lat": -24.34144199312179
                        },
                        {
                            "lng": -45.22084984536124,
                            "lat": -22.973871738414232
                        }]
                    );

                    disableForwardButton();
                    animateTweetsByDate();
                    enableForwardButtonOnDataIdle();

                    leftText.innerText = 'Esse dado geográfico pode ser extraído permitindo que ele seja projetado no território.'
  
                    rightText.style.opacity =1;
                    rightText.innerText = 'Tweets de Janeiro de 2022'
                }
            },
            {
                onInit: () => {
                    disableForwardButton()

                    animateTweetsByMonth();
                    var content = 'Durante o ano de 2022, 194.736* tweets marcaram a cidade de São Paulo, deixando o rastro de 30.365* usuários únicos.' +
                        '<br><br><span style="font-size: small;">*Dados após limpeza inicial.</span>';
                    leftText.innerHTML = content
                    // leftText.innerText = '' +
                    // "Durante o ano de 2022, 202.100 tweets marcaram a cidade, deixando o rastro de 30365 usuários únicos."
                    // TODO: 30365 é do scrape já limpo, junto com 194736 
                    rightText.innerText = 'Tweets de Janeiro a Dezembro de 2022'

                    enableForwardButtonOnDataIdle();

                }
            },
            {
                onInit: () => {
                    enableMapInteraction();
                    fadeOutLayer('title-layer', 3000);
                    fadeOutLayer('all-tweets-circle', 3000);
                    addAllTweetsData();

                    addAllTweetsLegend();

                    leftText.innerHTML = "A distribuição desses Tweets nos permite fazer leituras sobre a atividade social no território.<br><br>";

                    leftText.innerHTML += 'Mapa liberado para a interação!<br>Explore-o antes de avançar.<br>'+
                    'É possível dar zoom no mapa através do scroll do mouse e controles na lateral direita.'

                    rightText.innerText = 'Densidade de tweets por localização'

                }
            },
            {
                onInit: () => {
                    disableMapInteraction();

                    map.setPaintProperty('heatmap-layer', 'heatmap-opacity', 0.5)
                    map.flyTo({
                        essencial: true,
                        duration: 3000,
                        zoom: 13.8,
                        center: [-46.68909055256026, -23.56751326250103]
                    })


                    leftText.innerHTML = "Bairros centrais são, em geral, os mais movimentados no Twitter, mas aproximando nosso olhar, notamos diferenças nessa distribuição. " +
                    "Pinheiros e Vila Madalena são marcados por um dinamismo social, com bares, restaurantes, refletido no Twitter. " +
                    "Porém ao lado, o Jardim Eropa, bairro predominantemente residencial, aparece como um vazio nos dados."


                }
            },
            {
                onInit: () => {
                    displayPointsInPlace(paulistaLocationData, 14.5)

                    leftTextDiv.style.top = '40%';

                    leftText.innerHTML = "O Twitter também reage a datas relevantes para a cidade. Centro cultural e social de São Paulo, a Avenida Paulista é palco de manifestações diversas e seus picos de atividades refletem momentos sociais e políticos importantes na dinâmica urbana.<br><br>" +
                        "São exemplos os seguintes eventos:<br>" +
                        "Manifestações 7 de Setembro;<br>" +
                        "Parada Gay 19 de Junho;<br>" +
                        "Primeiro turno 02 de outoubro;<br>" +
                        "Segundo turno 30 de outubro."
                }
            },
            {
                onInit: () => {
                    // TEMPORÁRIO
                    // leftText.style.opacity = 1;
                    // enableForwardButton();

                    map.removeLayer('place-data-layer');
                    map.removeSource('place-data');
                    map.removeLayer('filtered-data-layer');
                    map.removeSource('filtered-data');

                    displayPointsInPlace(newoQuimicaArenaLocationData, 14);


                    // TODO: fazer relação com o item anterior
                    leftText.innerHTML = "" +
                        "A Neo Química Arena, casa do time Corinthians, representa uma das maiores atividades no Twitter. Aqui temos um exemplo de um polo atrator pendular, uma vez que o maior número de tweets acontece nas quartas-feiras e finais de semana, acompanhando as agendas de jogos do time."
                }
            },
            {
                onInit: () => {
                    map.removeLayer('place-data-layer');
                    map.removeSource('place-data');
                    map.removeLayer('filtered-data-layer');
                    map.removeSource('filtered-data');


                    disableForwardButton()
                    Plotly.purge('chart');



                    var coordinates = [-46.640614524898524, -23.54209992129087]
                    map.flyTo({
                        center: coordinates,
                        essencial: true,
                        duration: 3000,
                        zoom: 15,
                    })

                    map.addLayer({
                        id: 'bar-brahma-point-layer',
                        type: 'circle',
                        source: {
                            type: 'geojson',
                            data: {
                                type: 'Feature',
                                geometry: {
                                    type: 'Point',
                                    coordinates: coordinates
                                }
                            }
                        },
                        paint: {
                            'circle-color': brownColor,
                            'circle-radius': 10,
                        }
                    });

                    leftTextDiv.style.top = '50%';

                    const barBrahmaInitialText = `E por falar em estádios, nada melhor que visitar o Bar Brahma e aproveitar
                    <span id="t1">“samba, chopp e futebol.”</span>
                    num <span id="t2">“#Sabadou”</span>! <br>
                    Um brinde! Ou, em alemão, <span id="t3">“Prosit!”</span>`;
                    leftText.innerHTML = barBrahmaInitialText;


                    window.tweetData = [
                        {
                            id: "t1",
                            // color: "hsla(120, 94%, 22%, 1)",
                            color: "#9AB1B1",
                            strokeColor: '#658383',
                            name: "Rogério",
                            text: "Dia 28 de maio Rogério tweetou,",
                        },
                        {
                            id: "t2",
                            color: "#8E8EC2",
                            strokeColor: '#39397C',
                            // color: "lightblue",
                            // strokeColor: 'darkblue',
                            name: "Fernanda",
                            text: "em janeiro Fernanda aproveitou seu sábado,",
                        },
                        {
                            id: "t3",
                            // color: "pink",
                            // strokeColor: '#af0451',
                            color: "#DAA59A",
                            strokeColor: '#D05864',
                            name: "Lucas",
                            text: "e já em novembro Lucas comemorou.",
                        },
                    ];

                    let time_ = 3000;

                    // TEMPORARIO 
                    // let time_ = 1;

                    let tweetouText = "";

                    function action() {
                        setTimeout(() => {
                            upperLeftText.style.opacity = 1;
                            tweetouText += "Um lugar é marcado por aqueles que o ocupam:<br><br>";
                            upperLeftText.innerHTML = tweetouText
                        }, time_);

                        tweetData.forEach((tweet, index) => {
                            // TEMPORARIO
                            time_ += 3000;
                            // time_ += 1;


                            setTimeout(() => {
                                const { id, color, text, strokeColor } = tweet;
                                const t = document.getElementById(id);
                                t.style.color = strokeColor;

                                const tweetouText = `<span id="${id}a">${text}</span><br>`;
                                upperLeftText.innerHTML += tweetouText;

                                var ta = document.getElementById(`${id}a`);
                                ta.style.color = strokeColor;

                                map.setPaintProperty('bar-brahma-point-layer', 'circle-color', color);
                                map.setPaintProperty('bar-brahma-point-layer', 'circle-stroke-color', strokeColor);
                                map.setPaintProperty('bar-brahma-point-layer', 'circle-stroke-width', 2);

                                if (index == (tweetData.length - 1)) {
                                    enableForwardButton();
                                }
                            }, time_);
                        });
                    }


                    protectReduceMotion(action, 3000)

                }
            },
            {
                onInit: () => {


                    disableForwardButton();

                    map.setPaintProperty('bar-brahma-point-layer', 'circle-color', 'rgba(0,0,0,0)');
                    map.setPaintProperty('bar-brahma-point-layer', 'circle-stroke-color', brownColor);
                    map.setPaintProperty('bar-brahma-point-layer', 'circle-stroke-width', 1);


                    legend.style.opacity = 0;
                    rightText.style.opacity = 0;
                    fadeOutLayer('heatmap-layer', 3000);

                    upperLeftText.style.opacity = 0;
                    leftText.style.opacity = 0;

                    var initialMapCenter = [-46.73498283354363, -23.62918244629528]
                    var initialMapCenter = [-46.64061452489855, -23.542099921290863];
                    var initialMapZoom = 10.5;

                    // TODO: isso ta certo?
                    const paths = [
                        // { path: 1265649820225753089, color: 'hsla(120, 94%, 22%, 1)' },
                        // { path: 3724233975, color: 'darkblue' },
                        // { path: 15410917, color: '#af0451' },
                        { path: 3724233975, color: tweetData[0].color, strokeColor: tweetData[0].strokeColor },
                        { path: 15410917, color: tweetData[2].color, strokeColor: tweetData[2].strokeColor },
                        { path: 1265649820225753089, color: tweetData[1].color, strokeColor: tweetData[1].strokeColor },
                        { path: 52500909, color: '#DEBF7C', strokeColor: '#D09C3E' },
                        { path: 299835847, color: '#A6BC9E', strokeColor: '#498334' }
                        // { path: 299835847, color: '#C0C491', strokeColor: '#57956E' }

                    ];

                    map.flyTo({
                        center: [-46.759236634449536, -23.600183585556806],
                        zoom: initialMapZoom,
                        duration: 2000,
                        essential: true
                    })

                    addPathSources();


                    // TODO: remover, temporário

                    protectReduceMotion(() => {
                        const delay = 2500; // Delay of 1 second (1000 milliseconds)

                        leftText.style.opacity = 1;
                        leftText.innerHTML = `<span style="color:${tweetData[0].strokeColor}">${tweetData[0].name}</span>, ` +
                            `<span style="color:${tweetData[2].strokeColor}">${tweetData[2].name}</span>, e ` +
                            `<span style="color:${tweetData[1].strokeColor}">${tweetData[1].name}</span> ` +
                            `também registraram suas visitas em outros lugares.<br><br><br>`
                        setTimeout(() => {
                            leftText.innerHTML = leftText.innerHTML.slice(0, -4).slice(0, -4) + `Assim como <span style="color:${paths[3].strokeColor}">outras</span> <span style="color:${paths[4].strokeColor}">pessoas</span><br> que visitaram o Bar Brahma.`
                        }, delay * 3)

                        let index = 0;

                        function addPathWithDelay() {
                            if (index < paths.length) {
                                const { path, color, strokeColor } = paths[index];
                                addPathFromUser(path, color, strokeColor);
                                index++;
                                setTimeout(addPathWithDelay, delay);
                            } else if (index === paths.length) {
                                enableForwardButton();
                            }
                        }

                        addPathWithDelay();
                    }, 2500)


                    // map.once('moveend', () => {
                    //     const delay = 2500; // Delay of 1 second (1000 milliseconds)

                    //     leftText.style.opacity = 1;
                    //     leftText.innerHTML = `<span style="color:${tweetData[0].strokeColor}">${tweetData[0].name}</span>, ` +
                    //         `<span style="color:${tweetData[1].strokeColor}">${tweetData[1].name}</span>, e ` +
                    //         `<span style="color:${tweetData[2].strokeColor}">${tweetData[2].name}</span> ` +
                    //         `também registraram suas visitas em outros lugares da cidade.<br><br>`
                    //     setTimeout(() => {
                    //         leftText.innerHTML = leftText.innerHTML.slice(0, -4) + "Assim como outros que visitaram o Bar Brahma."
                    //     }, delay * 3)

                    //     let index = 0;

                    //     function addPathWithDelay() {
                    //         if (index < paths.length) {
                    //             const { path, color, strokeColor } = paths[index];
                    //             addPathFromUser(path, color, strokeColor);
                    //             index++;
                    //             setTimeout(addPathWithDelay, delay);
                    //         } else if (index === paths.length) {
                    //             enableForwardButton();
                    //         }
                    //     }

                    //     addPathWithDelay();
                    // });

                }


            },

            {
                onInit: () => {

                    leftText.style.opacity = 0


                    upperLeftText.innerHTML = "Ao compartilhar autores, estes lugares estabelecem uma relação entre si. Todos que estiveram aqui, também estiveram lá, construindo uma <b>Rede de Coincidências</b>: uma rede centralizada formada por todos os lugares que compartilham rastros de usuários com um lugar escolhido."
                    upperLeftText.style.opacity = 1;

                    // layerRastroLinesIds.forEach(layerId => {
                    //     fadeOutLayer(layerId, 3000);
                    // });

                    // TODO adicionar opacity transaction
                    var destinationFeatures = getDestinationFeatures('rastros_brahma_ord_geom_p')
                    networkBrahmaLineDistances = addNetworkLines(
                        'network-lines-layer-brahma',
                        [-46.64060333, -23.54209212],
                        // [-46.64061452489855, -23.542099921290863],
                        destinationFeatures,
                        layerRastroPointsIds);

                    layerRastroPointsIds.forEach(layerId => {
                        map.setPaintProperty(layerId, 'circle-color', brownColor)
                    });
                    // fadeOutLayer('network-lines-layer-brahma', 2000);

                }

            },
            {
                onInit: () => {
                    disableForwardButton();

                    // TEMPORARIO COMENTARIO
                    layerRastroPointsIds.forEach(layerId => {
                        map.setPaintProperty(layerId, 'circle-stroke-opacity', 0)
                    });
                    changeNetworkLinesColors('network-lines-layer-brahma');


                    upperLeftText.innerHTML += "<br><br>"
                    upperLeftText.innerHTML += "Cada um desses vincúlos possuiu diferentes comprimentos, demonstrando maiores ou menores distâncias entre os lugares relacionados."
                    //TODO: melhorar texto

                    addNetworkLegend();

                    setTimeout(() => {
                        // TEMPORARIO COMENTARIO
                        addNetworkChart();
                        enableForwardButton(); //
                        map.removeLayer('bar-brahma-point-layer');
                    }, 3000)

                }

            },
            {
                onInit: () => {
                    disableForwardButton();

                    // upperLeftText.style.opacity = 0

                    // upperLeftText.innerHTML = "Para então avaliar o quanto do abrangente aquela rede é, podemos utilizar o percentil 75, o qual representa o valor abaixo do qual 75% dos dados estão localizados." +
                    //     " Ao mesmo tempo que valoriza valores maiores que a média, também evita que outliers definam a nossa análise." +
                    //     "<br> Podemos então cruzar esse valor com a quantidade de autores únicos em um local, inferindo a atratividade de um local."

                    upperLeftText.innerHTML = "Para então descrevermos o quão <b>abrangente</b> aquela rede é, escolhemos o valor abaixo do qual 75% dos dados se encontram." +
                    " Ao mesmo tempo que esse considera valores acima da média, valorizando vincúlos mais extensos, também evita que valores muito altos de exceção definam a nossa análise." +
                    "<br><br>Cruzamos esse valor com a quantidade de autores únicos em um local, inferindo a <b>atratividade social</b> desse, e projetando-a no mapa."
                

                    // leftText.style.opacity = 1;

                    getSymbolLayers().forEach(l => {
                        map.setPaintProperty(l, 'text-opacity', 0);
                    })


                    // TEMPORARIO COMENTARIO
                    annotateNetworkChart();



                    setTimeout(() => {
                     

                        // TEMPORARIO COMENTARIO
                        layerRastroPointsIds.forEach(layerId => {
                            fadeOutLayer(layerId, 500); // Fade out each layer over 5 seconds (5000 milliseconds)
                        });


                        map.flyTo({
                            essencial: true,
                            pitch: 63.5, //85, // pitch in degrees
                            bearing: -15, // 0, // bearing in degrees
                            zoom: 15, // 16.5,
                            duration: 5000,
                            center: [-46.64143429207843, -23.542134345326673],
                        })


                        var chosenGeometry = [-46.64060333, -23.54209212];

                        var filteredData = deckGLNetworkDistanceCountData.filter(function (item) {
                            return (
                                item.lon === chosenGeometry[0] &&
                                item.lat === chosenGeometry[1]
                            );
                        });

                        // map.removeLayer('network-lines-layer-brahma')
                        fadeOutLayer('network-lines-layer-brahma', 3000)

                        window.deckGLBrahma = addDeckGL(filteredData, 'network-text-layer-1');
                        addDeckGLAnnotation(filteredData);


                        protectReduceMotion(enableForwardButton, 4000)

                        // map.once('moveend', () => {
                            // enableForwardButton();
                        // })

                    }, 3000)

                }
            },
            {
                onInit: () => {
                    upperLeftText.style.opacity = 0;
                    disableForwardButton();

                    getSymbolLayers().forEach(l => {
                        map.setPaintProperty(l, 'text-opacity', 1);
                    });

                    // TODO voltar
                    deckOverlayTextAnnotation.finalize();

                    Plotly.purge('network-chart');

                    window.filteredData = deckGLNetworkDistanceCountData.filter(function (item) {
                        return (
                            item.count >= 50
                        );
                    });

                    //  Só um teste para ver qual era o menor 
                    // const minDistance = filteredData.reduce((min, obj) => {
                    // return obj.distance_75p < min ? obj.distance_75p : min;
                    // }, Infinity);
                    // console.log(minDistance); 420

                    map.flyTo({
                        pitch: 32, //43, //45 // pitch in degrees
                        bearing: -35.8,//-51, //-55 // bearing in degrees
                        zoom: 10.5,
                        center: { lng: -46.654636628016846, lat: -23.60001019642887 }, //[-46.630898903953494, -23.672758159095864],
                        duration: 3000,
                        essencial: true,
                        curve: 1,
                        easing: function (t) {
                            return t;
                        }
                    })

                    addDeckGL(filteredData, 'network-text-layer-all')

                    setTimeout(()=> {
                        upperLeftText.innerHTML = "A altura das colunas nos mostra a quantidade de usuários individuais que twittaram naquele local, enquanto o degradê de cores nos representa a abrangência da Rede.<br><br>";
                        upperLeftText.innerHTML += "Podemos então visualizar o quanto um local é capaz de se conectar, através de rastros dos seus visitantes, com locais geograficamente distantes."
                        upperLeftText.style.opacity = 1;

                        rightText.innerHTML = 'Atratividade social por localização e Redes de Coincidências'
                        rightText.style.opacity = 1;

                        // remove o item do deckGL
                        // TODO voltar
                        deckGLBrahma.finalize();
                    }, 2000)
                    
                        


                    setTimeout(()=> {
                        enableForwardButton();
                    }, 3000)

                    protectReduceMotion(enableForwardButton, 2000)


                    // map.once('moveend', () => {
                    //     // enableMapInteraction();
                    //     upperLeftText.innerHTML = "Esse texto explica um monte de coisa. <br><br> Mapa liberado para interação.";
                    //     // remove o item do deckGL
                    //     deckGLBrahma.finalize();
                    // })



                    // setTimeout(() => {
                    //     map.flyTo({
                    //         pitch: 45, // pitch in degrees
                    //         bearing: -55, // bearing in degrees
                    //         zoom: 10.4,
                    //         center: [-46.630898903953494, -23.672758159095864],
                    //         duration: 3000,
                    //         essencial: true,
                    //         curve: 1, // Change the speed at which it zooms out.
                    //         // This can be any easing function: it takes a number between
                    //         // 0 and 1 and returns another number between 0 and 1.
                    //         easing: function (t) {
                    //             return t;
                    //         }
                    //     })

                    //     map.once('moveend', () => {
                    //         enableMapInteraction();
                    //         upperLeftText.innerHTML = "Esse texto explica um monte de coisa. <br><br> Mapa liberado para interação.";
                    //     })
                    // }, 2000

                    // )
                }
            },
            {
                onInit: () => {
                    columnsRadius = 300;

                    // Alianz
                    var choice = 'Sao Paulo (-23.52781293, -46.67891512)'
                    networkFromDeckGL(choice, flyTo = false)

                    upperLeftText.innerHTML = 'O Allianz Parque, estádio do Palmeira e palco de shows e eventos, é o ponto com maior números de tweets. '
                    upperLeftText.innerHTML += 'Sua rede é espraiada em uma ampla área geográfica, que conectam lugares e pessoas de várias regiões.'
                    
                }
            },
            {
                onInit: () => {
                    // masp
                    var choice = 'Sao Paulo (-23.56150556, -46.65594625)'
                    networkFromDeckGL(choice, flyTo = false)

                    upperLeftText.innerHTML = 'O MASP também conta com possui uma relativa alta quantidade de usuários tweetando. No entretanto a maioria dos rastros dos visitantes está concentrada à região central, próximo ao museu.'

                }
            },
            {
                onInit: () => {
                    var choice = 'Sao Paulo (-23.55100483, -46.64895978)'
                    // Parque Augusta (-23.55017918151177, -46.64921522140503)
                    networkFromDeckGL(choice, flyTo = false)
                    upperLeftText.innerHTML = 'O Parque Augusta também apresenta um perfil concentrado de relações.'
                }
            },       
            {
                onInit: () => {
                    // Itaquera
                    var choice = 'Sao Paulo (-23.5333, -46.45)';
                    networkFromDeckGL(choice, flyTo = false)
                    upperLeftText.innerHTML = 'Uma vez que há uma maioria de tweets na região central, a abrangência da rende tende a ser maior na região periféria. '
                    upperLeftText.innerHTML += 'Ainda sim conseguimos visualizar a sua dinâmica regional, como em Itaquera, forte polo na cidade e na região.'

                }
            },
            {
                onInit: () => {
                    var choice = 'Brás (-23.554646, -46.628054)'
                    networkFromDeckGL(choice, flyTo = false)
                    upperLeftText.innerHTML = 'Já Brás, mesmo estando em área central e possuindo um número relativamente baixo de autores únicos, demostra uma conexão com lugares distantes do território.'

                }
            },
            
            {
                onInit: () => {

                    var choice = 'Comando da 2ª Região Militar (-23.579597944073882, -46.65751516847958)'
                    networkFromDeckGL(choice, flyTo = false)

                    upperLeftText.innerHTML = 'Um exemplo curioso é o Comando da 2ª Região Militar, onde observamos uma quantidade significativa de autores únicos, '
                    upperLeftText.innerHTML += 'no entanto, comparando com lugares com a mesma quantidade, esses usuários estão se concentrando em locais pouco diversos. Essa situação levanta uma curiosidade sobre os dados: será que estamos lidando realmente como essa quantidade de usuário únicos, ou poucas pessoas, ou quem sabe bots, promovendo muito conteúdo?'
                    // [-46.65751516847958, -23.579597944073882]

                }
            },
            {
                onInit: () => {
                    const element = document.getElementById("network-chart");
                    element.remove();

                    function resetDeckGLView() {
                        columnsRadius = 50;

                        if (map.getLayer('network-lines-interactive-layer')) { map.removeLayer('network-lines-interactive-layer') };
                        if (map.getLayer('network-points-interactive-layer')) { map.removeLayer('network-points-interactive-layer') }

                        deckOverlay.setProps({
                            layers: [createNewColumnLayer(true, filteredData, null)]
                        });
                    }

                    // TODO esse é o radius mesmo
                    columnsRadius = 80;
                    otherColumnsOpacity = 20;
                    resetDeckGLView();
                    enableMapInteraction();

                    var button = document.createElement("button");
                    button.classList.add("reset-button");
                    button.innerHTML = "reiniciar visualização";
                    button.addEventListener("click", function () {
                        resetDeckGLView();
                    });

                    upperLeftText.innerHTML = null;
                    var span1 = document.createElement("span");

                    span1.innerHTML = "Agora é com você!<br>Fique à vontade para explorar o mapa e tirar suas próprias conclusões.<br><br>"

                    span1.innerHTML += 'Para visualizar a rede, clique na coluna.<br>Para girar o mapa, clique e arraste o mouse enquanto mantém pressionado o botão direito do mouse ou a tecla Ctrl.<br>Controles também estão disponíveis à direita.'
                    span1.innerHTML += '<br><br>'

                    var span2 = document.createElement("span");
                    span2.innerHTML += '<br><br><Br>O Twitter, apesar do seus recorte demográfico, pode ser uma rica base dados para explorarmos nossa cidade. Há uma incrível possibiliade de descoberta e esse projeto é um o convite para essa.'
                    
                    upperLeftText.appendChild(span1);
                    upperLeftText.appendChild(button);
                    upperLeftText.appendChild(span2);

                    

                    upperLeftText.style.opacity = 1;


                }
            },
            {
                onInit: () => {
                    disableMapInteraction();
                    rightText.style.opacity = 0;
                    upperLeftText.style.opacity = 0;
                    leftText.style.opacity = 0;
                    legend.style.opacity = 0;
                    disableForwardButton();
                    forwardButton.style.opacity = 0;

                    getSymbolLayers().forEach(l => {
                        map.setPaintProperty(l, 'text-opacity', 0);
                    });

                    map.flyTo({
                        essencial: true,
                        pitch: 0,
                        bearing: 0,
                        center: [-46.50146509120782, -23.764062538902365],
                        zoom: 12.5,
                        duration: 2000
                    })



                    setTimeout( () => {
                        var textContainer = document.createElement('div');
                        textContainer.id = 'final-text';
                        textContainer.innerHTML = '.';
                        document.body.appendChild(textContainer);
                        textContainer.style.opacity = 0.1;

                        var textBottomContainer = document.createElement('div');
                        textBottomContainer.id = 'final-bottom-text';
                        textBottomContainer.innerHTML = 'Trabalho Final de Graduação Arquitetura e Urbanismo USP<br>' +
                            'Roberta Saldanha da Silva Berardo Gomes<br>' +
                            'Orientador Prof. Dr. Leandro Velloso<br>' +
                            '2023';
                            
                        document.body.appendChild(textBottomContainer);

                        setTimeout(() => {
                            textContainer.style.opacity = 0.75;
                            textContainer.innerHTML = 'obrigada pela<br>visita!';
                            textBottomContainer.style.opacity = 1;
                        }, 500)


                    }, 2000)
                    


                }

            }

        ]

        // Add the GeoJSON data to the map
        map.on('load', function () {
            forwardButton.style.opacity = 1
            steps[currentStep].onInit();
        });


        forwardButton.addEventListener('click', () => {
            // backButton.style.display = 'block'

            if (currentStep < steps.length - 1) {
                currentStep++;
                steps[currentStep].onInit();
            }

        });


    </script>
</body>

</html>
